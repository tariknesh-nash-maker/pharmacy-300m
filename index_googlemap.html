<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pharmacy 300m — AI for Open Governance (Google Maps)</title>
  <style>
    :root { --panelW: 380px; }
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; color: #0f172a; }
    #map { position: absolute; inset: 56px 0 0 var(--panelW); }
    header { position: absolute; top: 0; left: 0; right: 0; height: 56px; display: flex; align-items: center; gap: 12px; padding: 0 14px; background: #0f172a; color: white; z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,0.08); }
    header .brand { font-weight: 700; letter-spacing: .2px; }
    .panel { position: absolute; top: 56px; left: 0; bottom: 0; width: var(--panelW); padding: 16px; overflow-y: auto; background: #fff; border-right: 1px solid #e5e7eb; z-index: 900; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    .step { margin-bottom: 18px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
    .step b { color: #0f172a; }
    .legend { position: absolute; right: 10px; bottom: 10px; background: rgba(255,255,255,0.95); padding: 8px 10px; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 12px; z-index: 500; }
    .legend div { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #9ca3af; }
    .footer { font-size: 12px; color: #475569; margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 10px; }
    .langSel { margin-left: auto; }
    .secondary { background:#fff; border:1px solid #cbd5e1; padding:6px 10px; border-radius:8px; cursor:pointer; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Pharmacy 300m Rule</div>
    <select id="langSel" class="langSel">
      <option value="en">English</option>
      <option value="fr">Français</option>
    </select>
  </header>

  <div class="panel">
    <h2 id="stepsTitle">4 Steps to Use</h2>
    <div class="step"><b id="s1">1. Identify a neighborhood</b><br><span id="s1txt">Draw your area of interest on the map.</span></div>
    <div class="step"><b id="s2">2. Add existing pharmacies</b><br><span id="s2txt">Click on the map to add pharmacies. Drag to move. Right-click to remove.</span></div>
    <div class="step"><b id="s3">3. Find recommendations</b><br>
      <button id="recommendBtn">Find spots</button>
      <button id="exportAllowedBtn" class="secondary" disabled>Export Allowed</button>
      <button id="exportRecsBtn" class="secondary" disabled>Export Recs</button>
    </div>
    <div class="step"><b id="s4">4. Save for the future</b><br>
      <button id="saveBtn" class="secondary">Save</button>
      <button id="loadBtn" class="secondary">Load</button>
      <button id="exportBtn" class="secondary" disabled>Export Project</button>
      <input id="importFile" type="file" accept=".json,.geojson,application/json"/>
    </div>

    <div id="stats">0 pharmacies • 0 areas</div>

    <div class="footer" id="footerText">
      <div id="whyTextEn">
        <p><b>Why this exists:</b> Many laws live in PDFs. This prototype shows how AI + maps can make a rule tangible for citizens and entrepreneurs. Today: the 300 m pharmacy rule. Tomorrow: budgets, access to information, public services.</p>
        <p><b>Why Open Data Matters:</b> This tool is only possible if the locations of pharmacies are openly available. Open data lets citizens and entrepreneurs verify compliance, helps regulators enforce rules fairly, and enables innovators to build services that make governance tangible.</p>
        <p><b>Legal context (Morocco):</b> According to Law n°17-04 (Code du médicament et de la pharmacie), Article 57, two pharmacies cannot be opened within 300 meters of each other, except by special authorization from the Ministry of Health. This rule is enforced by regional health authorities.</p>
        <p><b>Who can benefit:</b> Aspiring pharmacists, existing pharmacists, health authorities, civil society, and the open governance community.</p>
        <p>Contact us: <a href="mailto:neshnash@hotmail.com">neshnash@hotmail.com</a></p>
      </div>
      <div id="whyTextFr" style="display:none">
        <p><b>Pourquoi ce projet :</b> Beaucoup de lois restent enfermées dans des PDF. Ce prototype montre comment l’IA + la cartographie peuvent rendre une règle tangible pour les citoyens et les entrepreneurs. Aujourd’hui : la règle des 300 m entre pharmacies. Demain : budgets, accès à l’information, services publics.</p>
        <p><b>Pourquoi les données ouvertes comptent :</b> Cet outil n’est possible que si la localisation des pharmacies est accessible. Les données ouvertes permettent aux citoyens et entrepreneurs de vérifier la conformité, aident les autorités sanitaires à appliquer la règle équitablement, et permettent aux innovateurs de créer des services qui rendent la gouvernance concrète.</p>
        <p><b>Contexte légal (Maroc) :</b> Selon la loi n°17-04 (Code du médicament et de la pharmacie), article 57, deux pharmacies ne peuvent pas être ouvertes à moins de 300 mètres l’une de l’autre, sauf autorisation spéciale du Ministère de la Santé. Cette règle est appliquée par les autorités sanitaires régionales.</p>
        <p><b>Pour qui ?</b> Porteurs de projet, pharmaciens existants, autorités sanitaires, société civile et la communauté open gov.</p>
        <p>Contactez-nous : <a href="mailto:neshnash@hotmail.com">neshnash@hotmail.com</a></p>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div class="legend">
    <div><span class="swatch" style="background:#ef4444"></span> 300 m exclusion</div>
    <div><span class="swatch" style="background:#10b981"></span> Allowed area</div>
    <div><span class="swatch" style="background:#3b82f6"></span> Pharmacies</div>
    <div><span class="swatch" style="background:#f59e0b"></span> Recommendations</div>
  </div>

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
/* ---------- DOM refs FIRST ---------- */
const stepsTitle = document.getElementById('stepsTitle');
const s1 = document.getElementById('s1');
const s1txt = document.getElementById('s1txt');
const s2 = document.getElementById('s2');
const s2txt = document.getElementById('s2txt');
const s3 = document.getElementById('s3');
const s4 = document.getElementById('s4');
const recommendBtn = document.getElementById('recommendBtn');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const exportBtn = document.getElementById('exportBtn');
const exportRecsBtn = document.getElementById('exportRecsBtn');
const exportAllowedBtn = document.getElementById('exportAllowedBtn');
const langSel = document.getElementById('langSel');
const whyTextEn = document.getElementById('whyTextEn');
const whyTextFr = document.getElementById('whyTextFr');

/* ---------- i18n ---------- */
const STRINGS = {
  en: { stepsTitle:"4 Steps to Use", s1:"1. Identify a neighborhood", s1txt:"Draw your area of interest on the map.",
        s2:"2. Add existing pharmacies", s2txt:"Click on the map to add pharmacies. Drag to move. Right-click to remove.",
        s3:"3. Find recommendations", s4:"4. Save for the future",
        findBtn:"Find spots", save:"Save", load:"Load", export:"Export Project", exportRecs:"Export Recs", exportAllowed:"Export Allowed" },
  fr: { stepsTitle:"4 étapes d'utilisation", s1:"1. Identifier un quartier", s1txt:"Dessinez votre zone d’intérêt sur la carte.",
        s2:"2. Ajouter les pharmacies existantes", s2txt:"Cliquez sur la carte pour ajouter une pharmacie. Déplacez pour modifier. Clic droit pour supprimer.",
        s3:"3. Trouver des recommandations", s4:"4. Sauvegarder pour plus tard",
        findBtn:"Trouver des emplacements", save:"Sauvegarder", load:"Charger", export:"Exporter le projet", exportRecs:"Exporter Recos", exportAllowed:"Exporter zones autorisées" }
};
function setLangUI(lang){
  const S = STRINGS[lang] || STRINGS.en;
  stepsTitle.textContent = S.stepsTitle;
  s1.textContent = S.s1; s1txt.textContent = S.s1txt;
  s2.textContent = S.s2; s2txt.textContent = S.s2txt;
  s3.textContent = S.s3; s4.textContent = S.s4;
  recommendBtn.textContent = S.findBtn;
  saveBtn.textContent = S.save; loadBtn.textContent = S.load; exportBtn.textContent = S.export;
  exportRecsBtn.textContent = S.exportRecs; exportAllowedBtn.textContent = S.exportAllowed;
  whyTextEn.style.display = (lang === 'en') ? 'block' : 'none';
  whyTextFr.style.display = (lang === 'fr') ? 'block' : 'none';
}
langSel.addEventListener('change', e => setLangUI(e.target.value));
setLangUI('en');

/* ---------- Globals ---------- */
let map, drawingManager;
let circlesData, allowedData;            // created inside initMap()
const pharmacies = [];                   // [{marker, lat, lng}]
const aoiPolys = [];                     // [google.maps.Polygon]
const recsMarkers = [];                  // markers for recommendations
const LEGAL_BUFFER_M = 300;
const GRID_SPACING_KM = 0.05;            // 50m
const MIN_REC_SEP_M = 250;

/* ---------- Helpers ---------- */
function pharmaciesToFC(){
  return turf.featureCollection(pharmacies.map(p =>
    turf.point([p.marker.getPosition().lng(), p.marker.getPosition().lat()])
  ));
}
function aoiToFC(){
  const feats = aoiPolys.map(poly => {
    const path = poly.getPath().getArray().map(pt => [pt.lng(), pt.lat()]);
    if (path.length && (path[0][0] !== path[path.length-1][0] || path[0][1] !== path[path.length-1][1])) {
      path.push(path[0]);
    }
    return turf.polygon([path]);
  });
  return turf.featureCollection(feats);
}
function renderGeoJSON(dataLayer, geojson){
  dataLayer.forEach(f => dataLayer.remove(f));
  if (!geojson) return;
  if (geojson.type === 'FeatureCollection') geojson.features.forEach(f => dataLayer.addGeoJson(f));
  else dataLayer.addGeoJson(geojson);
}
function tryUnionJitter(a, b){
  try { return turf.union(a, b); }
  catch(e){
    try { return turf.union(turf.buffer(a,1e-4,{units:'kilometers'}), turf.buffer(b,1e-4,{units:'kilometers'})); }
    catch{ return a; }
  }
}
function computeZones(){
  if (!circlesData || !allowedData) return; // not ready until initMap runs
  renderGeoJSON(circlesData, null);
  renderGeoJSON(allowedData, null);

  const phFC = pharmaciesToFC();
  const circles = phFC.features.map(f => turf.circle(f.geometry.coordinates, LEGAL_BUFFER_M/1000, { units:'kilometers' }));
  const circlesFC = turf.featureCollection(circles);
  renderGeoJSON(circlesData, circlesFC);

  if (!aoiPolys.length) { updateExportButtons(); return; }

  const aoiFC = aoiToFC();
  let aoiUnion = aoiFC.features[0];
  for (let i=1; i<aoiFC.features.length; i++) aoiUnion = tryUnionJitter(aoiUnion, aoiFC.features[i]);

  let forbidden = circlesFC.features[0] || null;
  for (let i=1; i<circlesFC.features.length; i++) forbidden = forbidden ? tryUnionJitter(forbidden, circlesFC.features[i]) : circlesFC.features[i];

  let allowed = aoiUnion;
  if (forbidden) {
    try { allowed = turf.difference(aoiUnion, forbidden); }
    catch{ for (const f of circlesFC.features) { try { const d = turf.difference(allowed, f); if (d) allowed = d; } catch{} } }
  }
  if (allowed) renderGeoJSON(allowedData, allowed);
  updateExportButtons();
}
function addPharmacy(lat, lng){
  const marker = new google.maps.Marker({
    map, position:{lat, lng}, draggable:true,
    icon:{ path: google.maps.SymbolPath.CIRCLE, scale:6, fillColor:'#3b82f6', fillOpacity:1, strokeColor:'#1e40af', strokeWeight:1 }
  });
  marker.addListener('rightclick', () => {
    marker.setMap(null);
    const i = pharmacies.findIndex(p => p.marker === marker);
    if (i > -1) pharmacies.splice(i,1);
    computeZones(); updateStats(); saveState();
  });
  marker.addListener('dragend', () => { computeZones(); updateStats(); saveState(); });
  pharmacies.push({ marker, lat, lng });
  computeZones(); updateStats(); saveState();
}

/* ---------- Recommendations ---------- */
let lastRecs = [];
function clearRecs(){ recsMarkers.forEach(m => { m.setMap(null); if (m._label) m._label.setMap(null); }); recsMarkers.length = 0; }
function labelSVG(n){
  return `<svg xmlns='http://www.w3.org/2000/svg' width='40' height='22'><rect rx='6' ry='6' width='40' height='22' fill='%23f59e0b'/><text x='20' y='15' font-size='12' font-family='system-ui, sans-serif' text-anchor='middle' fill='white' font-weight='700'>#${n}</text></svg>`;
}
function nearestDistM(pt, pointsFC){ let best=Infinity; pointsFC.features.forEach(p=>{ const d=turf.distance(pt,p,{units:'kilometers'})*1000; if(d<best) best=d; }); return best; }
function avgKNearestM(pt, pointsFC, k){ const ds=pointsFC.features.map(p=>turf.distance(pt,p,{units:'kilometers'})*1000).sort((a,b)=>a-b); const kk=Math.min(k,ds.length); let s=0; for(let i=0;i<kk;i++) s+=ds[i]; return s/kk; }
function collectPolygons(gj){
  const out=[]; const pushPoly=coords=>out.push(turf.polygon(coords)); if(!gj) return out;
  if(gj.type==='FeatureCollection'){ gj.features.forEach(f=>{ const g=f.geometry; if(!g) return; if(g.type==='Polygon') pushPoly(g.coordinates); if(g.type==='MultiPolygon') g.coordinates.forEach(pushPoly); }); }
  else if(gj.type==='Feature'){ const g=gj.geometry; if(g?.type==='Polygon') pushPoly(g.coordinates); if(g?.type==='MultiPolygon') g.coordinates.forEach(pushPoly); }
  else if(gj.type==='Polygon'||gj.type==='MultiPolygon'){ return collectPolygons({type:'Feature',geometry:gj}); }
  return out;
}
document.getElementById('recommendBtn').addEventListener('click', () => {
  if (!aoiPolys.length || pharmacies.length === 0) { alert('Draw AOI and add pharmacies first.'); return; }
  let allowedGJ=null; allowedData.toGeoJson(gj=>{ allowedGJ=gj; });
  setTimeout(()=>{ // allow toGeoJson callback to run
    if(!allowedGJ){ alert('No allowed area.'); return; }
    const ph=pharmaciesToFC();
    const grid=turf.pointGrid(turf.bbox(allowedGJ), GRID_SPACING_KM, {units:'kilometers'});
    const polys=collectPolygons(allowedGJ);
    const candidates=grid.features.filter(pt=>polys.some(pg=>turf.booleanPointInPolygon(pt,pg)));
    const K=Math.min(3, ph.features.length);
    let scored=candidates.map(pt=>({ pt, dMin:nearestDistM(pt,ph), avgK:avgKNearestM(pt,ph,K) })).filter(r=>r.dMin>=LEGAL_BUFFER_M);
    if(!scored.length){ alert('No legal candidate points found. Try enlarging the AOI.'); clearRecs(); updateExportButtons(); return; }
    scored.sort((a,b)=>(a.avgK-b.avgK)||(a.dMin-b.dMin));
    const picked=[]; for(const r of scored){ let ok=true; for(const p of picked){ const dm=turf.distance(r.pt,p.pt,{units:'kilometers'})*1000; if(dm<MIN_REC_SEP_M){ ok=false; break; } } if(ok) picked.push(r); if(picked.length===8) break; }
    clearRecs();
    picked.forEach((r,i)=>{ const [lng,lat]=r.pt.geometry.coordinates;
      const m=new google.maps.Marker({ map, position:{lat,lng}, icon:{ path:google.maps.SymbolPath.CIRCLE, scale:7, fillColor:'#f59e0b', fillOpacity:1, strokeColor:'#b45309', strokeWeight:2 }, title:`Recommendation #${i+1}` });
      const lbl=new google.maps.Marker({ map, position:{lat,lng}, icon:{ url:`data:image/svg+xml;utf8,${encodeURIComponent(labelSVG(i+1))}` }, clickable:false });
      m._label=lbl; recsMarkers.push(m);
      const info=new google.maps.InfoWindow({ content:`<div>Recommendation #${i+1}<br>Nearest pharmacy: ${r.dMin.toFixed(0)} m<br>Avg distance to ${Math.min(3,pharmacies.length)} nearest: ${r.avgK.toFixed(0)} m</div>` });
      m.addListener('click', ()=>info.open({map, anchor:m}));
    });
    lastRecs=picked; updateStats(); updateExportButtons(); saveState();
  },0);
});

/* ---------- Export buttons ---------- */
function updateExportButtons(){
  if (!allowedData) { exportAllowedBtn.disabled = true; exportRecsBtn.disabled = (lastRecs.length===0); return; }
  let hasAllowed=false; allowedData.forEach(()=>{ hasAllowed=true; });
  exportAllowedBtn.disabled=!hasAllowed;
  exportRecsBtn.disabled=(lastRecs.length===0);
}
exportAllowedBtn.addEventListener('click', () => {
  if (!allowedData) return;
  allowedData.toGeoJson(gj => {
    const blob = new Blob([JSON.stringify(gj)], { type: 'application/geo+json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'allowed_areas.geojson'; a.click();
    URL.revokeObjectURL(url);
  });
});
exportRecsBtn.addEventListener('click', () => {
  if (!lastRecs.length) return;
  const fc = turf.featureCollection(lastRecs.map((r,i)=>turf.point(r.pt.geometry.coordinates,{rank:i+1, nearest_m:Number(r.dMin.toFixed(1)), avgK_m:Number(r.avgK.toFixed(1))})));
  const blob = new Blob([JSON.stringify(fc)], { type: 'application/geo+json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pharmacy_recommendations.geojson'; a.click();
  URL.revokeObjectURL(url);
});

/* ---------- Save / Load / Import / Export ---------- */
function saveState(){
  const state = {
    pharmacies: pharmacies.map(p => ({ lat: p.marker.getPosition().lat(), lng: p.marker.getPosition().lng() })),
    aoi: aoiToFC(),
    lang: langSel.value,
    recs: lastRecs.map(r => ({ lng: r.pt.geometry.coordinates[0], lat: r.pt.geometry.coordinates[1], dMin: r.dMin, avgK: r.avgK }))
  };
  localStorage.setItem('pharma300', JSON.stringify(state));
  exportBtn.disabled = false;
}
function loadProject(state){
  try{
    pharmacies.splice(0).forEach(p=>p.marker.setMap(null));
    aoiPolys.splice(0).forEach(p=>p.setMap(null));
    if (circlesData && allowedData) { renderGeoJSON(circlesData,null); renderGeoJSON(allowedData,null); }
    clearRecs();

    if (state.lang) { langSel.value = state.lang; setLangUI(state.lang); }
    (state.pharmacies||[]).forEach(p=>addPharmacy(p.lat,p.lng));
    if (state.aoi){
      (state.aoi.features||[]).forEach(f=>{
        if (f.geometry?.type==='Polygon'){
          const path=f.geometry.coordinates[0].map(([x,y])=>({lat:y,lng:x}));
          const poly=new google.maps.Polygon({ map, paths:path, fillColor:'#93c5fd', fillOpacity:0.12, strokeColor:'#3b82f6', strokeOpacity:0.9, strokeWeight:2 });
          poly.addListener('rightclick', ()=>{ poly.setMap(null); const i=aoiPolys.indexOf(poly); if(i>-1) aoiPolys.splice(i,1); computeZones(); updateStats(); saveState(); });
          aoiPolys.push(poly);
        }
      });
    }
    computeZones();
    lastRecs=[]; (state.recs||[]).forEach(r=>{ lastRecs.push({ pt:turf.point([r.lng,r.lat]), dMin:r.dMin||0, avgK:r.avgK||0 }); });
    if (lastRecs.length){ clearRecs(); lastRecs.forEach((r,i)=>{ const [lng,lat]=r.pt.geometry.coordinates;
      const m=new google.maps.Marker({ map, position:{lat,lng}, icon:{ path:google.maps.SymbolPath.CIRCLE, scale:7, fillColor:'#f59e0b', fillOpacity:1, strokeColor:'#b45309', strokeWeight:2 }, title:`Recommendation #${i+1}` });
      const lbl=new google.maps.Marker({ map, position:{lat,lng}, icon:{ url:`data:image/svg+xml;utf8,${encodeURIComponent(labelSVG(i+1))}` }, clickable:false });
      m._label=lbl; recsMarkers.push(m);
    }); }
    updateStats(); updateExportButtons();
  }catch(e){ alert('Failed to load project: '+e.message); }
}
saveBtn.addEventListener('click', ()=>{ saveState(); alert('Project saved.'); });
loadBtn.addEventListener('click', ()=>{ const raw=localStorage.getItem('pharma300'); if(!raw) return alert('No saved project.'); loadProject(JSON.parse(raw)); });
exportBtn.addEventListener('click', ()=>{ const raw=localStorage.getItem('pharma300')||'{}'; const blob=new Blob([raw],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pharmacy_project.json'; a.click(); URL.revokeObjectURL(url); });
document.getElementById('importFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const state=JSON.parse(txt); localStorage.setItem('pharma300', JSON.stringify(state)); loadProject(state); } catch(err){ alert('Import failed: '+err.message); } });

function updateStats(){ const recCount=lastRecs.length; const aoiCount=aoiPolys.length; document.getElementById('stats').textContent = `${pharmacies.length} pharmacies • ${aoiCount} AOIs • ${recCount} recs`; }

/* ---------- initMap (GLOBAL) ---------- */
function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
  center: { lat: 35.7595, lng: -5.8340 },
  zoom: 14,
  mapTypeId: google.maps.MapTypeId.SATELLITE,   // 👈 default satellite
  mapTypeControl: true,                         // let users switch if they want
  mapTypeControlOptions: {
    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
    position: google.maps.ControlPosition.TOP_RIGHT
  },
  streetViewControl: false
});

  // data layers (create AFTER API is loaded)
  circlesData = new google.maps.Data({ map });
  circlesData.setStyle({ fillOpacity:0.25, strokeColor:'#ef4444', fillColor:'#ef4444', strokeWeight:1 });
  allowedData = new google.maps.Data({ map });
  allowedData.setStyle({ fillOpacity:0.35, strokeColor:'#10b981', fillColor:'#10b981', strokeWeight:1 });

  // drawing tools
  drawingManager = new google.maps.drawing.DrawingManager({
    drawingControl:true,
    drawingControlOptions:{ position:google.maps.ControlPosition.TOP_LEFT, drawingModes:['polygon','rectangle'] },
    polygonOptions:{ fillColor:'#93c5fd', fillOpacity:0.12, strokeColor:'#3b82f6', strokeOpacity:0.9, strokeWeight:2 },
    rectangleOptions:{ fillColor:'#93c5fd', fillOpacity:0.12, strokeColor:'#3b82f6', strokeOpacity:0.9, strokeWeight:2 }
  });
  drawingManager.setMap(map);

  google.maps.event.addListener(drawingManager, 'overlaycomplete', (e)=>{
    if (e.type==='polygon'){ aoiPolys.push(e.overlay); }
    else if (e.type==='rectangle'){
      const b=e.overlay.getBounds();
      const poly=new google.maps.Polygon({ map, paths:[
        {lat:b.getSouthWest().lat(), lng:b.getSouthWest().lng()},
        {lat:b.getNorthEast().lat(), lng:b.getSouthWest().lng()},
        {lat:b.getNorthEast().lat(), lng:b.getNorthEast().lng()},
        {lat:b.getSouthWest().lat(), lng:b.getNorthEast().lng()}
      ], fillColor:'#93c5fd', fillOpacity:0.12, strokeColor:'#3b82f6', strokeOpacity:0.9, strokeWeight:2 });
      e.overlay.setMap(null); aoiPolys.push(poly);
    }
    computeZones(); updateStats(); saveState();
    const poly=aoiPolys[aoiPolys.length-1];
    poly.addListener('rightclick', ()=>{ poly.setMap(null); const i=aoiPolys.indexOf(poly); if(i>-1) aoiPolys.splice(i,1); computeZones(); updateStats(); saveState(); });
  });

  map.addListener('click', (e)=>addPharmacy(e.latLng.lat(), e.latLng.lng()));

  setLangUI(langSel.value);

  const raw=localStorage.getItem('pharma300'); if(raw){ try{ loadProject(JSON.parse(raw)); }catch{} }
}
window.initMap = initMap; // expose for callback
  </script>

  <!-- Load Google Maps (use a VALID key; enable Maps JavaScript API + Drawing) -->
  <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-hpFz31_2_VFsrX9bC_dT_ldM3xaoxoA&libraries=places,drawing&callback=initMap">
</script>
</body>
</html>
